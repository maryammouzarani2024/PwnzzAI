<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Real DoS - Pizza Paradise</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <div class="container">
            <nav class="navbar">
                <a href="{{ url_for('index') }}" class="logo">Pizza<span>Paradise</span></a>
            </nav>
        </div>
    </header>
    
    {% include 'navbar.html' %}

    <main class="container">
        <h1>LLM Real DoS Attack</h1>
        
        <div class="basics-content">
            <section class="basics-section">
                <h2>LLM Vulnerability: Real-World Denial of Service</h2>
                <p>This demonstration shows how an attacker can perform a Denial of Service (DoS) attack against OpenAI's API by overwhelming it with a high volume of requests. This can potentially:</p>
                <ul class="risk-list">
                    <li>Exhaust your OpenAI API credit balance quickly</li>
                    <li>Cause you to exceed your rate limits</li>
                    <li>Result in significant financial costs</li>
                </ul>

                <div class="warning-box">
                    <h3><i class="fas fa-exclamation-triangle"></i> Warning</h3>
                    <p>This demo will use your OpenAI API key to make real API calls. If you use the attack feature, you <strong>WILL</strong> be charged for all the API calls made during the attack. Use at your own risk and only for educational purposes.</p>
                </div>
                
                <div class="api-key-section">
                    <h3>Enter Your OpenAI API Key</h3>
                    <p>To use this demo, you need to provide your OpenAI API key. This key will only be used for this demo and won't be stored anywhere.</p>
                    
                    <div class="api-key-input">
                        <input type="password" id="api-key" class="form-control" placeholder="sk-...">
                        <button id="save-key-btn" class="btn">Save Key</button>
                    </div>
                    <p class="api-key-note"><small>Your API key is only stored in your browser's memory and will be cleared when you close this page.</small></p>
                </div>
                
                <div id="api-content" style="display: none;">
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-btn active" data-tab="insecure">Insecure Implementation</button>
                            <button class="tab-btn" data-tab="secure">Secure Implementation</button>
                        </div>
                        
                        <div class="tab-content">
                            <!-- Insecure Implementation Tab -->
                            <div class="tab-pane active" id="insecure-tab">
                                <h3>Vulnerable Implementation (No Rate Limiting)</h3>
                                <p>This chat interface connects directly to the OpenAI API without any rate limiting. An attacker can easily overwhelm the API with requests, leading to a denial of service and potential financial damage.</p>
                                
                                <div class="chat-interface">
                                    <div class="chat-history" id="insecure-chat-history">
                                        <div class="system-message">System: Welcome to the insecure LLM chat. This implementation has NO rate limiting.</div>
                                    </div>
                                    
                                    <div class="chat-input">
                                        <textarea id="insecure-prompt" class="form-control chat-textarea" placeholder="Type your message here..."></textarea>
                                        <button id="insecure-send-btn" class="btn chat-send-btn">
                                            <i class="fas fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="attack-section">
                                    <h3>DoS Attack Demonstration</h3>
                                    <p>Click the button below to simulate a DoS attack by sending multiple requests to the OpenAI API. <strong>This will use your API credits and may result in charges to your account.</strong></p>
                                    
                                    <div class="attack-controls">
                                        <div class="attack-settings">
                                            <div class="form-group">
                                                <label for="insecure-request-count">Number of Requests:</label>
                                                <input type="number" id="insecure-request-count" class="form-control" value="10" min="1" max="100">
                                            </div>
                                            <div class="form-group">
                                                <label for="insecure-prompt-template">Prompt Template:</label>
                                                <textarea id="insecure-prompt-template" class="form-control" rows="3">Generate a detailed pizza recipe with the following toppings: {random_toppings}. Include cooking time and temperature.</textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="attack-buttons">
                                            <button id="insecure-attack-btn" class="btn btn-danger">
                                                <i class="fas fa-bomb"></i> Launch DoS Attack
                                            </button>
                                            <button id="insecure-stop-attack-btn" class="btn btn-secondary" disabled>
                                                <i class="fas fa-stop-circle"></i> Stop Attack
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="insecure-attack-progress" class="attack-progress" style="display: none;">
                                        <div class="progress-bar-container">
                                            <div id="insecure-progress-bar" class="progress-bar"></div>
                                        </div>
                                        <div class="progress-stats">
                                            <span id="insecure-progress-text">0 / 0 requests sent</span>
                                            <span id="insecure-success-count">Success: 0</span>
                                            <span id="insecure-failure-count">Failed: 0</span>
                                        </div>
                                    </div>
                                    
                                    <div id="insecure-attack-results" class="attack-results" style="display: none;">
                                        <h4>Attack Results</h4>
                                        <div class="results-stats">
                                            <div class="result-stat">
                                                <div class="stat-label">Total Requests</div>
                                                <div id="insecure-total-requests" class="stat-value">0</div>
                                            </div>
                                            <div class="result-stat">
                                                <div class="stat-label">Successful</div>
                                                <div id="insecure-total-success" class="stat-value">0</div>
                                            </div>
                                            <div class="result-stat">
                                                <div class="stat-label">Failed</div>
                                                <div id="insecure-total-failed" class="stat-value">0</div>
                                            </div>
                                            <div class="result-stat">
                                                <div class="stat-label">Estimated Cost</div>
                                                <div id="insecure-est-cost" class="stat-value">$0.00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Secure Implementation Tab -->
                            <div class="tab-pane" id="secure-tab">
                                <h3>Secure Implementation (With Rate Limiting)</h3>
                                <p>This chat interface implements proper rate limiting to protect against DoS attacks. It limits the number of requests that can be made in a given time period, preventing API abuse.</p>
                                
                                <div class="chat-interface">
                                    <div class="chat-history" id="secure-chat-history">
                                        <div class="system-message">System: Welcome to the secure LLM chat. This implementation has rate limiting protection.</div>
                                    </div>
                                    
                                    <div class="chat-input">
                                        <textarea id="secure-prompt" class="form-control chat-textarea" placeholder="Type your message here..."></textarea>
                                        <button id="secure-send-btn" class="btn chat-send-btn">
                                            <i class="fas fa-paper-plane"></i> Send
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="rate-limit-info">
                                    <h4><i class="fas fa-shield-alt"></i> Rate Limiting Protection</h4>
                                    <p>This implementation limits API calls to:</p>
                                    <ul>
                                        <li>3 requests per minute</li>
                                        <li>50 requests per hour</li>
                                        <li>Token counting to prevent excessive usage</li>
                                    </ul>
                                    <div id="rate-limit-status" class="rate-limit-status">
                                        <div class="limit-item">
                                            <span class="limit-label">Minute Limit:</span>
                                            <div class="limit-progress">
                                                <div id="minute-progress" class="limit-bar" style="width: 0%"></div>
                                            </div>
                                            <span id="minute-count">0/3</span>
                                        </div>
                                        <div class="limit-item">
                                            <span class="limit-label">Hour Limit:</span>
                                            <div class="limit-progress">
                                                <div id="hour-progress" class="limit-bar" style="width: 0%"></div>
                                            </div>
                                            <span id="hour-count">0/50</span>
                                        </div>
                                        <div class="limit-reset">
                                            <span>Rate limits reset in: <span id="limit-reset-time">60:00</span></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="attack-section">
                                    <h3>DoS Attack Demonstration (Protected)</h3>
                                    <p>Try to perform the same DoS attack on the protected implementation. The rate limiting should prevent the attack from succeeding.</p>
                                    
                                    <div class="attack-controls">
                                        <div class="attack-settings">
                                            <div class="form-group">
                                                <label for="secure-request-count">Number of Requests:</label>
                                                <input type="number" id="secure-request-count" class="form-control" value="10" min="1" max="100">
                                            </div>
                                            <div class="form-group">
                                                <label for="secure-prompt-template">Prompt Template:</label>
                                                <textarea id="secure-prompt-template" class="form-control" rows="3">Generate a detailed pizza recipe with the following toppings: {random_toppings}. Include cooking time and temperature.</textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="attack-buttons">
                                            <button id="secure-attack-btn" class="btn btn-danger">
                                                <i class="fas fa-bomb"></i> Launch DoS Attack
                                            </button>
                                            <button id="secure-stop-attack-btn" class="btn btn-secondary" disabled>
                                                <i class="fas fa-stop-circle"></i> Stop Attack
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="secure-attack-progress" class="attack-progress" style="display: none;">
                                        <div class="progress-bar-container">
                                            <div id="secure-progress-bar" class="progress-bar"></div>
                                        </div>
                                        <div class="progress-stats">
                                            <span id="secure-progress-text">0 / 0 requests sent</span>
                                            <span id="secure-success-count">Success: 0</span>
                                            <span id="secure-failure-count">Failed: 0</span>
                                        </div>
                                    </div>
                                    
                                    <div id="secure-attack-results" class="attack-results" style="display: none;">
                                        <h4>Attack Results</h4>
                                        <div class="results-stats">
                                            <div class="result-stat">
                                                <div class="stat-label">Total Requests</div>
                                                <div id="secure-total-requests" class="stat-value">0</div>
                                            </div>
                                            <div class="result-stat">
                                                <div class="stat-label">Successful</div>
                                                <div id="secure-total-success" class="stat-value">0</div>
                                            </div>
                                            <div class="result-stat">
                                                <div class="stat-label">Rate Limited</div>
                                                <div id="secure-total-rate-limited" class="stat-value">0</div>
                                            </div>
                                            <div class="result-stat">
                                                <div class="stat-label">Estimated Cost</div>
                                                <div id="secure-est-cost" class="stat-value">$0.00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="basics-section">
                <h2>Understanding DoS Attacks on LLM APIs</h2>
                <p>Denial of Service (DoS) attacks against LLM APIs like OpenAI can have significant impacts:</p>
                
                <h3>Real-World Impact</h3>
                <ul class="risk-list">
                    <li><strong>Financial Damage:</strong> LLM providers like OpenAI charge per token. A DoS attack can quickly rack up thousands of dollars in API charges.</li>
                    <li><strong>Service Disruption:</strong> Even with per-user rate limits, exceeding these limits will make the API unavailable for legitimate use.</li>
                    <li><strong>Account Suspension:</strong> Unusual activity patterns might trigger account suspension, requiring time to resolve with customer support.</li>
                    <li><strong>Resource Depletion:</strong> In self-hosted LLMs, DoS attacks can consume all available computational resources.</li>
                </ul>
                
                <h3>Effective Mitigation Strategies</h3>
                <ul class="mitigation-list">
                    <li><strong>Client-Side Rate Limiting:</strong> Implement token buckets or sliding window rate limiters in your application</li>
                    <li><strong>Request Throttling:</strong> Add intentional delays between requests</li>
                    <li><strong>Usage Monitoring:</strong> Track token usage and API calls with alerts for unusual activity</li>
                    <li><strong>Request Validation:</strong> Validate and sanitize inputs before sending to the API</li>
                    <li><strong>Cost Caps:</strong> Set hard limits on API spending to prevent runaway costs</li>
                    <li><strong>Request Pooling:</strong> Batch multiple requests together to reduce API calls</li>
                </ul>
                
                <h3>Implementation Example</h3>
                <div class="code-example">
                    <h4>Secure Rate Limiting Implementation</h4>
                    <pre class="code-block">
class RateLimiter {
    constructor(limit, interval) {
        this.limit = limit;        // Maximum number of requests
        this.interval = interval;  // Time window in milliseconds
        this.tokens = limit;       // Available tokens
        this.lastRefill = Date.now();
        this.requests = [];        // Timestamp of requests
    }
    
    // Check if a request can be made
    canMakeRequest() {
        // Refill tokens based on time elapsed
        this.refillTokens();
        
        // Remove old requests outside the window
        const now = Date.now();
        this.requests = this.requests.filter(time => 
            now - time < this.interval);
            
        // Check if under the limit and have tokens
        return this.requests.length < this.limit && this.tokens > 0;
    }
    
    // Record a successful request
    addRequest() {
        if (!this.canMakeRequest()) {
            return false;
        }
        
        this.requests.push(Date.now());
        this.tokens--;
        return true;
    }
    
    // Refill tokens based on time elapsed
    refillTokens() {
        const now = Date.now();
        const timeElapsed = now - this.lastRefill;
        
        // Calculate tokens to add based on time elapsed
        const tokensToAdd = Math.floor(
            (timeElapsed * this.limit) / this.interval
        );
        
        if (tokensToAdd > 0) {
            this.tokens = Math.min(this.limit, this.tokens + tokensToAdd);
            this.lastRefill = now;
        }
    }
    
    // Get time until next available request
    getTimeUntilAvailable() {
        if (this.canMakeRequest()) {
            return 0;
        }
        
        // If we have requests at the limit
        if (this.requests.length >= this.limit) {
            const oldestRequest = Math.min(...this.requests);
            return this.interval - (Date.now() - oldestRequest);
        }
        
        // If we're out of tokens
        return this.interval / this.limit;
    }
}
</pre>
                </div>
            </section>
        </div>
    </main>

    <style>
        .warning-box {
            background-color: #fff3cd;
            border: 2px solid #ffeeba;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .warning-box h3 {
            color: #856404;
            margin-top: 0;
        }
        
        .warning-box i {
            margin-right: 10px;
        }
        
        .api-key-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }
        
        .api-key-input {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .api-key-input input {
            flex: 1;
        }
        
        .api-key-note {
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* Tab Styles */
        .tab-container {
            margin: 20px 0;
        }
        
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background-color: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .tab-btn:hover {
            background-color: #f8f9fa;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Rate Limit Info */
        .rate-limit-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .rate-limit-info h4 {
            color: #0c5460;
            margin-top: 0;
        }
        
        .rate-limit-info i {
            margin-right: 10px;
        }
        
        .rate-limit-status {
            margin-top: 15px;
        }
        
        .limit-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .limit-label {
            width: 100px;
            font-weight: 500;
        }
        
        .limit-progress {
            flex: 1;
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .limit-bar {
            height: 100%;
            background-color: #17a2b8;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .limit-reset {
            margin-top: 10px;
            text-align: right;
            font-size: 0.9rem;
            color: #0c5460;
        }
        
        /* Code Example */
        .code-example {
            margin: 20px 0;
        }
        
        /* Reuse styles from existing CSS for chat interface, attack section, etc. */
        .chat-interface {
            margin: 20px 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .chat-history {
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom: 1px solid #e9ecef;
        }
        
        .system-message {
            color: #6c757d;
            font-style: italic;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f2f2f2;
            border-radius: 8px;
        }
        
        .user-message, .assistant-message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        
        .user-message {
            background-color: #DCF8C6;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .assistant-message {
            background-color: #FFFFFF;
            border: 1px solid #E5E5EA;
            align-self: flex-start;
        }
        
        .message-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        
        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
        }
        
        .chat-textarea {
            flex: 1;
            resize: none;
            height: 50px;
            margin-right: 10px;
            border-radius: 20px;
            padding: 12px 15px;
        }
        
        .chat-send-btn {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .chat-send-btn i {
            margin: 0;
        }
        
        .attack-section {
            margin-top: 40px;
            border-top: 1px solid #e9ecef;
            padding-top: 30px;
        }
        
        .attack-controls {
            margin: 20px 0;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .attack-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .attack-settings .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .attack-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .attack-progress {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #007bff;
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .progress-stats {
            display: flex;
            justify-content: space-between;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .attack-results {
            margin: 20px 0;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .results-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-stat {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #212529;
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // API Key handling
            const apiKeyInput = document.getElementById('api-key');
            const saveKeyBtn = document.getElementById('save-key-btn');
            const apiContent = document.getElementById('api-content');
            
            // Check if API key is already saved in session storage
            const savedApiKey = sessionStorage.getItem('openai_api_key');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                apiContent.style.display = 'block';
            }
            
            // Save API key to session storage
            saveKeyBtn.addEventListener('click', function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('Please enter a valid OpenAI API key.');
                    return;
                }
                
                if (!apiKey.startsWith('sk-')) {
                    alert('The API key should start with "sk-". Please check your key.');
                    return;
                }
                
                // Save to session storage
                sessionStorage.setItem('openai_api_key', apiKey);
                apiContent.style.display = 'block';
                alert('API key saved. You can now use the demo.');
            });
            
            // Tab switching
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and panes
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to current button and pane
                    this.classList.add('active');
                    document.getElementById(tabId + '-tab').classList.add('active');
                });
            });
            
            // Chat functionality for insecure implementation
            const insecureChatHistory = document.getElementById('insecure-chat-history');
            const insecurePrompt = document.getElementById('insecure-prompt');
            const insecureSendBtn = document.getElementById('insecure-send-btn');
            
            insecureSendBtn.addEventListener('click', function() {
                sendMessage(insecurePrompt, insecureChatHistory, false);
            });
            
            insecurePrompt.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(insecurePrompt, insecureChatHistory, false);
                }
            });
            
            // Chat functionality for secure implementation
            const secureChatHistory = document.getElementById('secure-chat-history');
            const securePrompt = document.getElementById('secure-prompt');
            const secureSendBtn = document.getElementById('secure-send-btn');
            
            secureSendBtn.addEventListener('click', function() {
                sendMessage(securePrompt, secureChatHistory, true);
            });
            
            securePrompt.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage(securePrompt, secureChatHistory, true);
                }
            });
            
            // Rate limiting for secure implementation
            const rateLimiter = {
                minuteLimit: 3,
                hourLimit: 50,
                minuteRequests: [],
                hourRequests: [],
                
                // Check if request is allowed
                canMakeRequest: function() {
                    const now = Date.now();
                    
                    // Clean up old requests
                    this.minuteRequests = this.minuteRequests.filter(time => now - time < 60000); // 1 minute
                    this.hourRequests = this.hourRequests.filter(time => now - time < 3600000); // 1 hour
                    
                    // Update UI
                    this.updateUI();
                    
                    // Check limits
                    return this.minuteRequests.length < this.minuteLimit && 
                           this.hourRequests.length < this.hourLimit;
                },
                
                // Add request
                addRequest: function() {
                    if (!this.canMakeRequest()) {
                        return false;
                    }
                    
                    const now = Date.now();
                    this.minuteRequests.push(now);
                    this.hourRequests.push(now);
                    
                    // Update UI
                    this.updateUI();
                    return true;
                },
                
                // Update UI
                updateUI: function() {
                    // Update minute progress
                    const minuteProgress = document.getElementById('minute-progress');
                    const minuteCount = document.getElementById('minute-count');
                    const minutePercentage = (this.minuteRequests.length / this.minuteLimit) * 100;
                    
                    minuteProgress.style.width = minutePercentage + '%';
                    minuteCount.textContent = this.minuteRequests.length + '/' + this.minuteLimit;
                    
                    // Update hour progress
                    const hourProgress = document.getElementById('hour-progress');
                    const hourCount = document.getElementById('hour-count');
                    const hourPercentage = (this.hourRequests.length / this.hourLimit) * 100;
                    
                    hourProgress.style.width = hourPercentage + '%';
                    hourCount.textContent = this.hourRequests.length + '/' + this.hourLimit;
                    
                    // Update reset time
                    if (this.minuteRequests.length > 0) {
                        const oldestRequest = Math.min(...this.minuteRequests);
                        const timeToReset = 60 - Math.floor((Date.now() - oldestRequest) / 1000);
                        document.getElementById('limit-reset-time').textContent = '00:' + (timeToReset < 10 ? '0' + timeToReset : timeToReset);
                    } else {
                        document.getElementById('limit-reset-time').textContent = '01:00';
                    }
                }
            };
            
            // Start a timer to update the rate limit UI
            setInterval(function() {
                rateLimiter.updateUI();
            }, 1000);
            
            // Function to send a message to the OpenAI API
            function sendMessage(promptElem, historyElem, isSecure) {
                const message = promptElem.value.trim();
                if (!message) return;
                
                // Check if API key is available
                const apiKey = sessionStorage.getItem('openai_api_key');
                if (!apiKey) {
                    alert('Please enter your OpenAI API key first.');
                    return;
                }
                
                // For secure implementation, check rate limiting
                if (isSecure && !rateLimiter.canMakeRequest()) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message-error';
                    errorDiv.textContent = 'Error: Rate limit exceeded. Please try again later.';
                    historyElem.appendChild(errorDiv);
                    historyElem.scrollTop = historyElem.scrollHeight;
                    return;
                }
                
                // Add user message to chat
                addMessageToChat('User', message, historyElem);
                
                // Clear input
                promptElem.value = '';
                
                // Add typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing';
                typingIndicator.innerHTML = `
                    <span>Assistant is typing</span>
                    <div class="dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                `;
                historyElem.appendChild(typingIndicator);
                historyElem.scrollTop = historyElem.scrollHeight;
                
                // Create the request to OpenAI API
                const reqBody = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        { role: "system", content: "You are a helpful assistant specialized in pizza recipes and information." },
                        { role: "user", content: message }
                    ],
                    max_tokens: 150
                };
                
                // Send request to OpenAI API
                fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(reqBody)
                })
                .then(response => {
                    // For secure implementation, record the request
                    if (isSecure) {
                        rateLimiter.addRequest();
                    }
                    
                    // Check if rate limited by OpenAI
                    if (response.status === 429) {
                        throw new Error('Rate limit exceeded by OpenAI. Please try again later.');
                    }
                    
                    return response.json();
                })
                .then(data => {
                    // Remove typing indicator
                    historyElem.removeChild(typingIndicator);
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'Unknown error');
                    }
                    
                    // Add assistant response to chat
                    const assistantResponse = data.choices[0].message.content;
                    addMessageToChat('Assistant', assistantResponse, historyElem);
                })
                .catch(error => {
                    // Remove typing indicator
                    if (typingIndicator.parentNode === historyElem) {
                        historyElem.removeChild(typingIndicator);
                    }
                    
                    // Show error message
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'message-error';
                    errorDiv.textContent = `Error: ${error.message}`;
                    historyElem.appendChild(errorDiv);
                    historyElem.scrollTop = historyElem.scrollHeight;
                });
            }
            
            // Function to add a message to the chat history
            function addMessageToChat(sender, text, historyElem) {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container';
                
                const senderElement = document.createElement('div');
                senderElement.className = 'message-sender';
                senderElement.textContent = sender;
                
                const messageElement = document.createElement('div');
                messageElement.className = sender === 'User' ? 'user-message' : 'assistant-message';
                messageElement.textContent = text;
                
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = timeString;
                
                messageContainer.appendChild(senderElement);
                messageContainer.appendChild(messageElement);
                messageContainer.appendChild(timeElement);
                
                historyElem.appendChild(messageContainer);
                historyElem.scrollTop = historyElem.scrollHeight;
            }
            
            // DoS Attack functionality for insecure implementation
            const insecureAttackBtn = document.getElementById('insecure-attack-btn');
            const insecureStopAttackBtn = document.getElementById('insecure-stop-attack-btn');
            const insecureRequestCount = document.getElementById('insecure-request-count');
            const insecurePromptTemplate = document.getElementById('insecure-prompt-template');
            const insecureAttackProgress = document.getElementById('insecure-attack-progress');
            const insecureProgressBar = document.getElementById('insecure-progress-bar');
            const insecureProgressText = document.getElementById('insecure-progress-text');
            const insecureSuccessCount = document.getElementById('insecure-success-count');
            const insecureFailureCount = document.getElementById('insecure-failure-count');
            const insecureAttackResults = document.getElementById('insecure-attack-results');
            
            // To keep track of the attack
            let isInsecureAttacking = false;
            let insecureAttackStats = {
                total: 0,
                success: 0,
                failed: 0,
                estimatedCost: 0
            };
            
            // Pizza toppings for random prompt generation
            const pizzaToppings = [
                'pepperoni', 'mushrooms', 'sausage', 'onions', 'bell peppers', 
                'black olives', 'bacon', 'pineapple', 'ham', 'garlic', 
                'spinach', 'tomatoes', 'feta cheese', 'blue cheese', 'mozzarella', 
                'parmesan', 'anchovies', 'artichoke hearts', 'eggplant', 'zucchini', 
                'broccoli', 'jalape√±os', 'chicken', 'beef', 'prosciutto', 
                'goat cheese', 'arugula', 'basil', 'corn', 'eggs'
            ];
            
            // Function to generate a random prompt
            function generateRandomPrompt(template) {
                // Get 2-4 random toppings
                const numToppings = Math.floor(Math.random() * 3) + 2;
                const selectedToppings = [];
                
                for (let i = 0; i < numToppings; i++) {
                    const randomTopping = pizzaToppings[Math.floor(Math.random() * pizzaToppings.length)];
                    if (!selectedToppings.includes(randomTopping)) {
                        selectedToppings.push(randomTopping);
                    }
                }
                
                const toppingsText = selectedToppings.join(', ');
                return template.replace('{random_toppings}', toppingsText);
            }
            
            // Launch insecure attack
            insecureAttackBtn.addEventListener('click', function() {
                const numRequests = parseInt(insecureRequestCount.value);
                if (numRequests < 1) {
                    alert('Please enter a valid number of requests.');
                    return;
                }
                
                // Check if API key is available
                const apiKey = sessionStorage.getItem('openai_api_key');
                if (!apiKey) {
                    alert('Please enter your OpenAI API key first.');
                    return;
                }
                
                // Confirm with user
                if (!confirm(`WARNING: This will send ${numRequests} real requests to OpenAI API using your API key. This WILL cost you money. Are you sure you want to continue?`)) {
                    return;
                }
                
                // Reset attack stats
                insecureAttackStats = {
                    total: numRequests,
                    success: 0,
                    failed: 0,
                    estimatedCost: 0
                };
                
                // Update UI
                insecureProgressBar.style.width = '0%';
                insecureProgressText.textContent = `0 / ${numRequests} requests sent`;
                insecureSuccessCount.textContent = 'Success: 0';
                insecureFailureCount.textContent = 'Failed: 0';
                insecureAttackProgress.style.display = 'block';
                insecureAttackResults.style.display = 'none';
                
                // Toggle buttons
                insecureAttackBtn.disabled = true;
                insecureStopAttackBtn.disabled = false;
                isInsecureAttacking = true;
                
                // Start the attack
                runInsecureAttack(numRequests, apiKey);
            });
            
            // Stop insecure attack
            insecureStopAttackBtn.addEventListener('click', function() {
                isInsecureAttacking = false;
                insecureStopAttackBtn.disabled = true;
                insecureAttackBtn.disabled = false;
                
                // Show results with current stats
                showInsecureAttackResults();
            });
            
            // Run insecure attack
            function runInsecureAttack(numRequests, apiKey) {
                let completed = 0;
                
                // Function to send a single request
                function sendRequest() {
                    if (!isInsecureAttacking || completed >= numRequests) {
                        // Attack completed or stopped
                        if (isInsecureAttacking && completed >= numRequests) {
                            isInsecureAttacking = false;
                            insecureStopAttackBtn.disabled = true;
                            insecureAttackBtn.disabled = false;
                            showInsecureAttackResults();
                        }
                        return;
                    }
                    
                    const prompt = generateRandomPrompt(insecurePromptTemplate.value);
                    
                    // Create the request to OpenAI API
                    const reqBody = {
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "You are a helpful assistant specialized in pizza recipes and information." },
                            { role: "user", content: prompt }
                        ],
                        max_tokens: 250
                    };
                    
                    // Send request to OpenAI API
                    fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(reqBody)
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Update stats
                        if (data.error) {
                            insecureAttackStats.failed++;
                        } else {
                            insecureAttackStats.success++;
                            
                            // Estimate cost (very approximate - $0.002 per 1K tokens)
                            if (data.usage) {
                                const totalTokens = data.usage.prompt_tokens + data.usage.completion_tokens;
                                insecureAttackStats.estimatedCost += (totalTokens / 1000) * 0.002;
                            }
                        }
                        
                        completed++;
                        
                        // Update progress UI
                        updateInsecureProgress(completed, numRequests);
                        
                        // Continue attack with next request
                        setTimeout(() => sendRequest(), 300); // Add a small delay to prevent rate limiting
                    })
                    .catch(error => {
                        completed++;
                        insecureAttackStats.failed++;
                        
                        // Update progress UI
                        updateInsecureProgress(completed, numRequests);
                        
                        // Continue attack with next request
                        setTimeout(() => sendRequest(), 300);
                    });
                }
                
                // Start multiple requests in parallel (a bit spaced out to avoid early rate limiting)
                const concurrency = 3;
                for (let i = 0; i < Math.min(concurrency, numRequests); i++) {
                    setTimeout(() => sendRequest(), i * 500);
                }
            }
            
            // Update insecure progress UI
            function updateInsecureProgress(completed, total) {
                const progress = (completed / total) * 100;
                insecureProgressBar.style.width = `${progress}%`;
                insecureProgressText.textContent = `${completed} / ${total} requests sent`;
                insecureSuccessCount.textContent = `Success: ${insecureAttackStats.success}`;
                insecureFailureCount.textContent = `Failed: ${insecureAttackStats.failed}`;
            }
            
            // Show insecure attack results
            function showInsecureAttackResults() {
                document.getElementById('insecure-total-requests').textContent = insecureAttackStats.total;
                document.getElementById('insecure-total-success').textContent = insecureAttackStats.success;
                document.getElementById('insecure-total-failed').textContent = insecureAttackStats.failed;
                document.getElementById('insecure-est-cost').textContent = '$' + insecureAttackStats.estimatedCost.toFixed(2);
                
                insecureAttackResults.style.display = 'block';
            }
            
            // DoS Attack functionality for secure implementation
            const secureAttackBtn = document.getElementById('secure-attack-btn');
            const secureStopAttackBtn = document.getElementById('secure-stop-attack-btn');
            const secureRequestCount = document.getElementById('secure-request-count');
            const securePromptTemplate = document.getElementById('secure-prompt-template');
            const secureAttackProgress = document.getElementById('secure-attack-progress');
            const secureProgressBar = document.getElementById('secure-progress-bar');
            const secureProgressText = document.getElementById('secure-progress-text');
            const secureSuccessCount = document.getElementById('secure-success-count');
            const secureFailureCount = document.getElementById('secure-failure-count');
            const secureAttackResults = document.getElementById('secure-attack-results');
            
            // To keep track of the secure attack
            let isSecureAttacking = false;
            let secureAttackStats = {
                total: 0,
                success: 0,
                failed: 0,
                rateLimited: 0,
                estimatedCost: 0
            };
            
            // Launch secure attack
            secureAttackBtn.addEventListener('click', function() {
                const numRequests = parseInt(secureRequestCount.value);
                if (numRequests < 1) {
                    alert('Please enter a valid number of requests.');
                    return;
                }
                
                // Check if API key is available
                const apiKey = sessionStorage.getItem('openai_api_key');
                if (!apiKey) {
                    alert('Please enter your OpenAI API key first.');
                    return;
                }
                
                // Confirm with user
                if (!confirm(`WARNING: Even though this is rate limited, this will still send some real requests to OpenAI API using your API key. This WILL cost you money, but much less than the insecure version. Are you sure you want to continue?`)) {
                    return;
                }
                
                // Reset attack stats
                secureAttackStats = {
                    total: numRequests,
                    success: 0,
                    failed: 0,
                    rateLimited: 0,
                    estimatedCost: 0
                };
                
                // Update UI
                secureProgressBar.style.width = '0%';
                secureProgressText.textContent = `0 / ${numRequests} requests sent`;
                secureSuccessCount.textContent = 'Success: 0';
                secureFailureCount.textContent = 'Failed: 0';
                secureAttackProgress.style.display = 'block';
                secureAttackResults.style.display = 'none';
                
                // Toggle buttons
                secureAttackBtn.disabled = true;
                secureStopAttackBtn.disabled = false;
                isSecureAttacking = true;
                
                // Start the attack
                runSecureAttack(numRequests, apiKey);
            });
            
            // Stop secure attack
            secureStopAttackBtn.addEventListener('click', function() {
                isSecureAttacking = false;
                secureStopAttackBtn.disabled = true;
                secureAttackBtn.disabled = false;
                
                // Show results with current stats
                showSecureAttackResults();
            });
            
            // Run secure attack
            function runSecureAttack(numRequests, apiKey) {
                let completed = 0;
                
                // Function to send a single request
                function sendRequest() {
                    if (!isSecureAttacking || completed >= numRequests) {
                        // Attack completed or stopped
                        if (isSecureAttacking && completed >= numRequests) {
                            isSecureAttacking = false;
                            secureStopAttackBtn.disabled = true;
                            secureAttackBtn.disabled = false;
                            showSecureAttackResults();
                        }
                        return;
                    }
                    
                    const prompt = generateRandomPrompt(securePromptTemplate.value);
                    
                    // Check if rate limited
                    if (!rateLimiter.canMakeRequest()) {
                        completed++;
                        secureAttackStats.rateLimited++;
                        
                        // Update progress UI
                        updateSecureProgress(completed, numRequests);
                        
                        // Continue attack with next request after a delay
                        setTimeout(() => sendRequest(), 1000);
                        return;
                    }
                    
                    // Record the request in rate limiter
                    rateLimiter.addRequest();
                    
                    // Create the request to OpenAI API
                    const reqBody = {
                        model: "gpt-3.5-turbo",
                        messages: [
                            { role: "system", content: "You are a helpful assistant specialized in pizza recipes and information." },
                            { role: "user", content: prompt }
                        ],
                        max_tokens: 250
                    };
                    
                    // Send request to OpenAI API
                    fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(reqBody)
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Update stats
                        if (data.error) {
                            secureAttackStats.failed++;
                        } else {
                            secureAttackStats.success++;
                            
                            // Estimate cost (very approximate - $0.002 per 1K tokens)
                            if (data.usage) {
                                const totalTokens = data.usage.prompt_tokens + data.usage.completion_tokens;
                                secureAttackStats.estimatedCost += (totalTokens / 1000) * 0.002;
                            }
                        }
                        
                        completed++;
                        
                        // Update progress UI
                        updateSecureProgress(completed, numRequests);
                        
                        // Continue attack with next request
                        setTimeout(() => sendRequest(), 300);
                    })
                    .catch(error => {
                        completed++;
                        secureAttackStats.failed++;
                        
                        // Update progress UI
                        updateSecureProgress(completed, numRequests);
                        
                        // Continue attack with next request
                        setTimeout(() => sendRequest(), 300);
                    });
                }
                
                // Start multiple requests (one at a time for secure implementation)
                sendRequest();
            }
            
            // Update secure progress UI
            function updateSecureProgress(completed, total) {
                const progress = (completed / total) * 100;
                secureProgressBar.style.width = `${progress}%`;
                secureProgressText.textContent = `${completed} / ${total} requests sent`;
                secureSuccessCount.textContent = `Success: ${secureAttackStats.success}`;
                secureFailureCount.textContent = `Rate Limited: ${secureAttackStats.rateLimited}, Failed: ${secureAttackStats.failed}`;
            }
            
            // Show secure attack results
            function showSecureAttackResults() {
                document.getElementById('secure-total-requests').textContent = secureAttackStats.total;
                document.getElementById('secure-total-success').textContent = secureAttackStats.success;
                document.getElementById('secure-total-rate-limited').textContent = secureAttackStats.rateLimited;
                document.getElementById('secure-est-cost').textContent = '$' + secureAttackStats.estimatedCost.toFixed(2);
                
                secureAttackResults.style.display = 'block';
            }
        });
    </script>
</body>
</html>